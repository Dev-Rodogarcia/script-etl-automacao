name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MAVEN_MIRROR_URL: ${{ secrets.MAVEN_MIRROR_URL }}
      MAVEN_MIRROR_USERNAME: ${{ secrets.MAVEN_MIRROR_USERNAME }}
      MAVEN_MIRROR_PASSWORD: ${{ secrets.MAVEN_MIRROR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Configure Maven Mirror (optional)
        if: env.MAVEN_MIRROR_URL != ''
        shell: bash
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <mirrors>
              <mirror>
                <id>corporate-mirror</id>
                <name>Corporate Maven Mirror</name>
                <url>${MAVEN_MIRROR_URL}</url>
                <mirrorOf>*</mirrorOf>
              </mirror>
            </mirrors>
            <servers>
              <server>
                <id>corporate-mirror</id>
                <username>${MAVEN_MIRROR_USERNAME}</username>
                <password>${MAVEN_MIRROR_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Warm Maven Cache (Dependencies + Plugins)
        run: mvn -B -ntp -DskipTests dependency:go-offline

      - name: Version Consistency Guard
        run: python3 scripts/ci/check_version_consistency.py

      - name: Throwable Catch Guard
        run: python3 scripts/ci/check_no_catch_throwable.py

      - name: Class Size Guard
        run: python3 scripts/ci/check_class_size_alert.py

      - name: Run Unit Tests
        run: mvn -B -ntp test

      - name: Build Packaged JAR
        run: mvn -B -ntp -DskipTests package

      - name: Smoke Test Packaged JAR
        run: bash scripts/ci/smoke_packaged_jar.sh

      - name: Basic Static Analysis (PMD Report)
        run: mvn -B -ntp -DskipTests=true org.apache.maven.plugins:maven-pmd-plugin:3.28.0:pmd

      - name: PMD Regression Guard
        run: python3 scripts/ci/check_pmd_regression.py

      - name: Dependency Audit (Maven Analyze)
        run: mvn -B -ntp -DskipTests=true org.apache.maven.plugins:maven-dependency-plugin:3.7.1:analyze-only

      - name: Duplicate SQL Guard
        run: python3 scripts/ci/check_duplicate_sql.py

      - name: Encoding Guard (UTF-8 / No Mojibake Regression)
        run: python3 scripts/ci/check_mojibake_regression.py

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review (Vulnerabilities)
        uses: actions/dependency-review-action@v4
