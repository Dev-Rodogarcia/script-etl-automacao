package br.com.extrator.comandos;

import java.time.Instant;
import java.time.LocalDate;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import br.com.extrator.auditoria.AuditoriaService;
import br.com.extrator.auditoria.ResultadoAuditoria;

/**
 * Comando respons√°vel por executar auditoria de dados do sistema.
 */
public class ExecutarAuditoriaComando implements Comando {
    private static final Logger logger = LoggerFactory.getLogger(ExecutarAuditoriaComando.class);
    
    @Override
    public void executar(String[] args) throws Exception {
        System.out.println("üìã Executando auditoria de dados...");
        try {
            final AuditoriaService auditoriaService = new AuditoriaService();
            ResultadoAuditoria resultado;
            
            // Verificar se foi especificado um per√≠odo customizado
            if (args.length >= 4 && "--periodo".equals(args[1])) {
                try {
                    final LocalDate dataInicioLocal = LocalDate.parse(args[2]);
                    final LocalDate dataFimLocal = LocalDate.parse(args[3]);
                    
                    // Converter para Instant (in√≠cio do dia e fim do dia em UTC)
                    final Instant dataInicio = dataInicioLocal.atStartOfDay().toInstant(java.time.ZoneOffset.UTC);
                    final Instant dataFim = dataFimLocal.atTime(23, 59, 59).toInstant(java.time.ZoneOffset.UTC);
                    
                    System.out.printf("üìÖ Executando auditoria para per√≠odo: %s at√© %s%n", 
                                    dataInicioLocal, dataFimLocal);
                    
                    resultado = auditoriaService.executarAuditoriaPorPeriodo(dataInicio, dataFim);
                    
                } catch (final Exception e) {
                    System.err.println("‚ùå ERRO: Formato de data inv√°lido. Use: YYYY-MM-DD YYYY-MM-DD");
                    System.err.println("Exemplo: --auditoria --periodo 2024-01-01 2024-01-31");
                    return;
                }
            } else {
                // Executar auditoria completa (padr√£o - √∫ltimas 24 horas)
                System.out.println("üìÖ Executando auditoria completa (√∫ltimas 24 horas)");
                resultado = auditoriaService.executarAuditoriaCompleta();
            }
            
            if (resultado != null && resultado.isSucesso()) {
                System.out.println("‚úÖ Auditoria conclu√≠da com sucesso!");
            } else {
                System.out.println("‚ö†Ô∏è  Auditoria conclu√≠da com alertas. Verifique os relat√≥rios gerados.");
            }
            
        } catch (final Exception e) {
            logger.error("Erro na auditoria de dados: {}", e.getMessage(), e);
            System.err.println("‚ùå ERRO na auditoria: " + e.getMessage());
            throw e; // Re-propaga para tratamento de alto n√≠vel
        }
    }
}