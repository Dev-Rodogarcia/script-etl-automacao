package br.com.extrator.runners;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import br.com.extrator.api.ClienteApiDataExport;
import br.com.extrator.api.ResultadoExtracao;
import br.com.extrator.db.entity.CotacaoEntity;
import br.com.extrator.db.entity.LocalizacaoCargaEntity;
import br.com.extrator.db.entity.ManifestoEntity;
import br.com.extrator.db.entity.LogExtracaoEntity;
import br.com.extrator.db.repository.CotacaoRepository;
import br.com.extrator.db.repository.LocalizacaoCargaRepository;
import br.com.extrator.db.repository.ManifestoRepository;
import br.com.extrator.db.repository.LogExtracaoRepository;
import br.com.extrator.modelo.dataexport.cotacao.CotacaoDTO;
import br.com.extrator.modelo.dataexport.cotacao.CotacaoMapper;
import br.com.extrator.modelo.dataexport.localizacaocarga.LocalizacaoCargaDTO;
import br.com.extrator.modelo.dataexport.localizacaocarga.LocalizacaoCargaMapper;
import br.com.extrator.modelo.dataexport.manifestos.ManifestoDTO;
import br.com.extrator.modelo.dataexport.manifestos.ManifestoMapper;

/**
 * Runner independente para a API Data Export (Manifestos, Cota√ß√µes e Localiza√ß√£o de Carga).
 */
public final class DataExportRunner {

    private DataExportRunner() {}

    public static void executar(final LocalDate dataInicio) throws Exception {
        System.out.println("üîÑ Executando runner DataExport...");

        br.com.extrator.util.CarregadorConfig.validarConexaoBancoDados();

        final ClienteApiDataExport clienteApiDataExport = new ClienteApiDataExport();
        final ManifestoRepository manifestoRepository = new ManifestoRepository();
        final CotacaoRepository cotacaoRepository = new CotacaoRepository();
        final LocalizacaoCargaRepository localizacaoRepository = new LocalizacaoCargaRepository();
        final LogExtracaoRepository logExtracaoRepository = new LogExtracaoRepository();

        final ManifestoMapper manifestoMapper = new ManifestoMapper();
        final CotacaoMapper cotacaoMapper = new CotacaoMapper();
        final LocalizacaoCargaMapper localizacaoMapper = new LocalizacaoCargaMapper();

        // Garante que a tabela log_extracoes existe
        logExtracaoRepository.criarTabelaSeNaoExistir();

        // Manifestos
        System.out.println("\nüßæ Extraindo Manifestos (√∫ltimas 24h)...");
        LocalDateTime inicioManifestos = LocalDateTime.now();
        try {
            final ResultadoExtracao<ManifestoDTO> resultadoManifestos = clienteApiDataExport.buscarManifestos();
            final List<ManifestoDTO> manifestosDTO = resultadoManifestos.getDados();
            System.out.println("‚úì Extra√≠dos: " + manifestosDTO.size() + " manifestos" + 
                              (resultadoManifestos.isCompleto() ? "" : " (INCOMPLETO: " + resultadoManifestos.getMotivoInterrupcao() + ")"));
            
            int registrosSalvos = 0;
            if (!manifestosDTO.isEmpty()) {
                final List<ManifestoEntity> manifestosEntities = manifestosDTO.stream()
                    .map(manifestoMapper::toEntity)
                    .collect(Collectors.toList());
                registrosSalvos = manifestoRepository.salvar(manifestosEntities);
                System.out.println("‚úì Salvos: " + registrosSalvos + "/" + manifestosDTO.size() + " manifestos");
            }

            // Registrar no log
            String status = resultadoManifestos.isCompleto() ? "COMPLETO" : "INCOMPLETO";
            String mensagem = resultadoManifestos.isCompleto() ? 
                "Extra√ß√£o completa" : 
                "Extra√ß√£o incompleta: " + resultadoManifestos.getMotivoInterrupcao();
            
            LogExtracaoEntity logManifestos = new LogExtracaoEntity(
                "manifestos",
                inicioManifestos,
                LocalDateTime.now(),
                status,
                registrosSalvos,
                resultadoManifestos.getPaginasProcessadas(),
                mensagem
            );
            logExtracaoRepository.gravarLogExtracao(logManifestos);

        } catch (RuntimeException | java.sql.SQLException e) {
            // Registrar erro no log
            LogExtracaoEntity logErro = new LogExtracaoEntity(
                "manifestos",
                inicioManifestos,
                LocalDateTime.now(),
                "ERRO_API",
                0,
                0,
                "Erro: " + e.getMessage()
            );
            logExtracaoRepository.gravarLogExtracao(logErro);
            throw new RuntimeException("Falha na extra√ß√£o de manifestos", e);
        }

        Thread.sleep(2000);

        // Cota√ß√µes
        System.out.println("\nüíπ Extraindo Cota√ß√µes (√∫ltimas 24h)...");
        LocalDateTime inicioCotacoes = LocalDateTime.now();
        try {
            final ResultadoExtracao<CotacaoDTO> resultadoCotacoes = clienteApiDataExport.buscarCotacoes();
            final List<CotacaoDTO> cotacoesDTO = resultadoCotacoes.getDados();
            System.out.println("‚úì Extra√≠das: " + cotacoesDTO.size() + " cota√ß√µes" + 
                              (resultadoCotacoes.isCompleto() ? "" : " (INCOMPLETO: " + resultadoCotacoes.getMotivoInterrupcao() + ")"));
            
            int registrosSalvos = 0;
            if (!cotacoesDTO.isEmpty()) {
                final List<CotacaoEntity> cotacoesEntities = cotacoesDTO.stream()
                    .map(cotacaoMapper::toEntity)
                    .collect(Collectors.toList());
                registrosSalvos = cotacaoRepository.salvar(cotacoesEntities);
                System.out.println("‚úì Salvas: " + registrosSalvos + "/" + cotacoesDTO.size() + " cota√ß√µes");
            }

            // Registrar no log
            String status = resultadoCotacoes.isCompleto() ? "COMPLETO" : "INCOMPLETO";
            String mensagem = resultadoCotacoes.isCompleto() ? 
                "Extra√ß√£o completa" : 
                "Extra√ß√£o incompleta: " + resultadoCotacoes.getMotivoInterrupcao();
            
            LogExtracaoEntity logCotacoes = new LogExtracaoEntity(
                "cotacoes",
                inicioCotacoes,
                LocalDateTime.now(),
                status,
                registrosSalvos,
                resultadoCotacoes.getPaginasProcessadas(),
                mensagem
            );
            logExtracaoRepository.gravarLogExtracao(logCotacoes);

        } catch (RuntimeException | java.sql.SQLException e) {
            // Registrar erro no log
            LogExtracaoEntity logErro = new LogExtracaoEntity(
                "cotacoes",
                inicioCotacoes,
                LocalDateTime.now(),
                "ERRO_API",
                0,
                0,
                "Erro: " + e.getMessage()
            );
            logExtracaoRepository.gravarLogExtracao(logErro);
            throw new RuntimeException("Falha na extra√ß√£o de cota√ß√µes", e);
        }

        Thread.sleep(2000);

        // Localiza√ß√£o de Carga
        System.out.println("\nüìç Extraindo Localiza√ß√£o de Carga (√∫ltimas 24h)...");
        LocalDateTime inicioLocalizacoes = LocalDateTime.now();
        try {
            final ResultadoExtracao<LocalizacaoCargaDTO> resultadoLocalizacoes = clienteApiDataExport.buscarLocalizacaoCarga();
            final List<LocalizacaoCargaDTO> localizacoesDTO = resultadoLocalizacoes.getDados();
            System.out.println("‚úì Extra√≠das: " + localizacoesDTO.size() + " localiza√ß√µes" + 
                              (resultadoLocalizacoes.isCompleto() ? "" : " (INCOMPLETO: " + resultadoLocalizacoes.getMotivoInterrupcao() + ")"));
            
            int registrosSalvos = 0;
            if (!localizacoesDTO.isEmpty()) {
                final List<LocalizacaoCargaEntity> localizacoesEntities = localizacoesDTO.stream()
                    .map(localizacaoMapper::toEntity)
                    .collect(Collectors.toList());
                registrosSalvos = localizacaoRepository.salvar(localizacoesEntities);
                System.out.println("‚úì Salvas: " + registrosSalvos + "/" + localizacoesDTO.size() + " localiza√ß√µes");
            }

            // Registrar no log
            String status = resultadoLocalizacoes.isCompleto() ? "COMPLETO" : "INCOMPLETO";
            String mensagem = resultadoLocalizacoes.isCompleto() ? 
                "Extra√ß√£o completa" : 
                "Extra√ß√£o incompleta: " + resultadoLocalizacoes.getMotivoInterrupcao();
            
            LogExtracaoEntity logLocalizacoes = new LogExtracaoEntity(
                "localizacao_cargas",
                inicioLocalizacoes,
                LocalDateTime.now(),
                status,
                registrosSalvos,
                resultadoLocalizacoes.getPaginasProcessadas(),
                mensagem
            );
            logExtracaoRepository.gravarLogExtracao(logLocalizacoes);

        } catch (RuntimeException | java.sql.SQLException e) {
            // Registrar erro no log
            LogExtracaoEntity logErro = new LogExtracaoEntity(
                "localizacao_cargas",
                inicioLocalizacoes,
                LocalDateTime.now(),
                "ERRO_API",
                0,
                0,
                "Erro: " + e.getMessage()
            );
            logExtracaoRepository.gravarLogExtracao(logErro);
            throw new RuntimeException("Falha na extra√ß√£o de localiza√ß√£o de cargas", e);
        }
    }
}