# Testes Isolados das APIs ESL Cloud

Este documento descreve como usar os arquivos `.bat` criados para testar cada API da ESL Cloud de forma isolada, verificando a conformidade com as regras estabelecidas.

## üìã Arquivos de Teste Dispon√≠veis

### 1. `testar_api_rest.bat`
- **Fun√ß√£o**: Testa apenas a API REST
- **Endpoints testados**:
  - Faturas a Receber
  - Faturas a Pagar
  - Ocorr√™ncias
- **Caracter√≠sticas**: Pagina√ß√£o autom√°tica, throttling configur√°vel

### 2. `testar_api_graphql.bat`
- **Fun√ß√£o**: Testa apenas a API GraphQL
- **Endpoints testados**:
  - Coletas (Conhecimentos)
  - Fretes
- **Caracter√≠sticas**: Pagina√ß√£o cursor-based, introspec√ß√£o de schema

### 3. `testar_api_dataexport.bat`
- **Fun√ß√£o**: Testa apenas a API Data Export
- **Endpoints testados**:
  - Manifestos
  - Cota√ß√µes
  - Localiza√ß√£o de Carga
- **Caracter√≠sticas**: Processamento de arquivos Excel/CSV

## üöÄ Como Executar os Testes

### Pr√©-requisitos
1. **Compilar o projeto**:
   ```bash
   mvn clean package
   ```

2. **Verificar configura√ß√µes** em `config.properties`:
   - `api.throttling.padrao_ms=5000` (padr√£o: 5 segundos)
   - `api.retry.max_tentativas=5`
   - `api.retry.delay_base_ms=2000`

### Execu√ß√£o
1. **Duplo clique** no arquivo `.bat` desejado
2. **Ou via linha de comando**:
   ```cmd
   testar_api_rest.bat
   testar_api_graphql.bat
   testar_api_dataexport.bat
   ```

## ‚úÖ Conformidade com Regras ESL Cloud

### 1. Rate Limit (Aplicado a todas as APIs)
- ‚úÖ **Intervalo m√≠nimo**: 2 segundos entre requisi√ß√µes
- ‚úÖ **Escopo**: Por tenant (rodogarcia) e IP p√∫blico
- ‚úÖ **Capacidade**: ~30 req/min, ~1.800 req/hora
- ‚úÖ **Tratamento HTTP 429**: Retry autom√°tico com backoff

### 2. Implementa√ß√£o de Boas Pr√°ticas
- ‚úÖ **Throttling obrigat√≥rio**: Configurado para 5000ms (acima do m√≠nimo)
- ‚úÖ **Retry para erro 429**: Implementado com backoff exponencial
- ‚úÖ **Controle de concorr√™ncia**: Serializa√ß√£o autom√°tica
- ‚úÖ **Timeout**: 30 segundos por requisi√ß√£o

### 3. Regras Espec√≠ficas da API Data Export
- ‚úÖ **< 31 dias**: Sem limite de horas entre extra√ß√µes
- ‚úÖ **31 dias - 6 meses**: Limite de 1 hora entre extra√ß√µes
- ‚úÖ **> 6 meses**: Limite de 12 horas entre extra√ß√µes

## üìä Monitoramento e Logs

### Arquivos Gerados
- **Logs**: `logs/` - Logs detalhados de execu√ß√£o
- **M√©tricas**: `metricas/` - Estat√≠sticas de performance
- **Dados**: `dados/` - Arquivos baixados (Data Export)

### Verifica√ß√£o na Plataforma TMS
- Acesse: `Parametriza√ß√µes ‚Üí Consumo`
- Monitore: N√∫mero de chamadas por rota
- Verifique: Conformidade com limites

## üîß Configura√ß√µes Avan√ßadas

### Vari√°veis de Ambiente (Opcionais)
```cmd
set API_THROTTLING_PADRAO_MS=2000
set API_RETRY_MAX_TENTATIVAS=3
set API_TIMEOUT_MS=30000
```

### Par√¢metros JVM
```cmd
-Dfile.encoding=UTF-8
-Djava.util.logging.config.file=src/main/resources/logging.properties
```

## üêõ Solu√ß√£o de Problemas

### Erro: JAR n√£o encontrado
```cmd
mvn clean package
```

### Erro HTTP 429 (Too Many Requests)
- ‚úÖ **Autom√°tico**: O sistema j√° implementa retry
- ‚ö†Ô∏è **Manual**: Aumente `api.throttling.padrao_ms` se necess√°rio

### Timeout de Conex√£o
- Verifique conectividade com ESL Cloud
- Considere aumentar `api.timeout.ms`

### Arquivos n√£o baixados (Data Export)
- Verifique permiss√µes na pasta `dados/`
- Confirme formato do arquivo (Excel/CSV)

## üìà M√©tricas Importantes

### Performance Esperada
- **REST**: ~100-500 registros por requisi√ß√£o
- **GraphQL**: ~50-200 registros por p√°gina
- **Data Export**: Arquivos completos (tamanho vari√°vel)

### Indicadores de Sucesso
- ‚úÖ Zero erros HTTP 429 ap√≥s retry
- ‚úÖ Tempo m√©dio entre requisi√ß√µes ‚â• 2 segundos
- ‚úÖ Taxa de sucesso > 95%
- ‚úÖ Logs sem erros cr√≠ticos

## Estrutura de Testes

### Testes de Integra√ß√£o
- Valida√ß√£o de conectividade com APIs
- Testes de fluxo completo de extra√ß√£o
- Verifica√ß√£o de integridade de dados

### Testes Unit√°rios
- Valida√ß√£o de componentes individuais
- Testes de l√≥gica de neg√≥cio
- Verifica√ß√£o de utilit√°rios e helpers

## üîç Funcionalidades Especiais

### API GraphQL - Introspec√ß√£o
```cmd
java -jar target/extrator-1.0-SNAPSHOT.jar --introspeccao
```

### Teste de Conectividade
```cmd
java -jar target/extrator-1.0-SNAPSHOT.jar --test-connection
```

## üìû Suporte

Em caso de problemas:
1. Verifique os logs em `logs/`
2. Consulte m√©tricas em `metricas/`
3. Monitore consumo na plataforma TMS
4. Ajuste configura√ß√µes em `config.properties`

---

**√öltima atualiza√ß√£o**: Janeiro 2025  
**Vers√£o**: 1.0  
**Compatibilidade**: ESL Cloud APIs v2024